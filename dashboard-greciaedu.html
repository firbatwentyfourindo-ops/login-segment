<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | GreciaEdu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #ffffff;
            background-image: radial-gradient(at 0% 0%, hsla(210,100%,99%,1) 0, transparent 50%), 
                              radial-gradient(at 100% 100%, hsla(210,100%,99%,1) 0, transparent 50%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .minimal-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid #f3f4f6;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.05);
        }

        .tab-btn {
            position: relative;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: #2563eb;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 25%;
            width: 50%;
            height: 3px;
            background: #2563eb;
            border-radius: 10px;
        }

        .video-preview {
            border-radius: 20px;
            overflow: hidden;
            background: #f1f5f9;
            aspect-ratio: 16 / 9;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #f8fafc 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .btn-action {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-action:active {
            transform: scale(0.96);
        }

        #toast {
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform: translateY(100px) translateX(-50%);
            opacity: 0;
            left: 50%;
        }
        #toast.show {
            transform: translateY(0) translateX(-50%);
            opacity: 1;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest animate-pulse">Memuat Data...</p>
    </div>

    <!-- Main Dashboard Container -->
    <div id="main-container" class="w-full max-w-sm hidden animate__animated animate__fadeIn">
        
        <!-- Header & Profile -->
        <div class="flex items-center justify-between mb-6">
            <img src="https://greciaco.id/wp-content/uploads/2025/09/cropped-cropped-logo_grecia-1-e1758353731842.png" alt="Logo Grecia" class="h-8 object-contain">
            
            <div id="user-profile" class="flex items-center gap-2 bg-white/60 p-1 pr-3 rounded-full border border-gray-100 shadow-sm backdrop-blur-sm">
                <!-- Avatar Image or Initial -->
                <div class="w-7 h-7 rounded-full overflow-hidden border border-white bg-slate-100 flex items-center justify-center">
                    <img id="user-avatar" src="" class="w-full h-full object-cover hidden">
                    <span id="user-initial" class="text-[10px] font-bold text-slate-500">U</span>
                </div>
                <div class="flex flex-col">
                    <span id="user-name" class="text-[10px] font-bold text-gray-600 truncate max-w-[80px]">User</span>
                    <span id="status-indicator" class="text-[8px] text-gray-400 font-bold leading-none mt-0.5">● Offline</span>
                </div>
            </div>
        </div>

        <div class="minimal-card rounded-[2.5rem] p-6 relative">
            
            <!-- Tabs Navigation -->
            <div class="flex border-b border-gray-100 mb-6 gap-2">
                <button onclick="window.switchTab('youtube')" id="tab-yt" class="tab-btn active flex-1 pb-3 text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-blue-500">YouTube</button>
                <button onclick="window.switchTab('zoom')" id="tab-zm" class="tab-btn flex-1 pb-3 text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-blue-500">Zoom</button>
                <button onclick="window.switchTab('whatsapp')" id="tab-wa" class="tab-btn flex-1 pb-3 text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-blue-500">
                    <span class="flex items-center justify-center gap-1">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.506-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                        WA
                    </span>
                </button>
            </div>

            <!-- Loader State -->
            <div id="session-loader" class="py-12 text-center hidden">
                <div class="w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Sinkronisasi Sesi...</p>
            </div>

            <!-- No Session State -->
            <div id="no-session-state" class="py-10 text-center hidden">
                <div class="w-14 h-14 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-3 text-gray-300">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h3 class="text-gray-800 font-bold text-xs">Belum Ada Sesi</h3>
                <p class="text-[10px] text-gray-400 mt-1">Admin belum memulai sesi live.</p>
            </div>

            <!-- Content: YouTube -->
            <div id="content-youtube" class="tab-content animate__animated animate__fadeIn">
                <div class="video-preview mb-5 shadow-sm border border-gray-50 relative group">
                    <div id="yt-skeleton" class="skeleton absolute inset-0"></div>
                    <img id="yt-thumb" src="" class="hidden w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">
                    <div class="absolute inset-0 bg-black/5 flex items-center justify-center group-hover:bg-black/10 transition-colors">
                         <div class="w-10 h-10 bg-white/90 backdrop-blur-md rounded-full flex items-center justify-center shadow-lg transform group-hover:scale-110 transition-transform duration-300">
                            <svg class="w-4 h-4 text-red-600 ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                        </div>
                    </div>
                </div>
                <a id="link-yt" href="#" onclick="window.trackClick('YOUTUBE')" target="_blank" class="btn-action w-full flex items-center justify-center gap-2 bg-red-600 text-white py-4 rounded-2xl font-bold text-[11px] shadow-lg shadow-red-100 tracking-wide uppercase">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"></path></svg>
                    Buka YouTube Live
                </a>
            </div>

            <!-- Content: Zoom -->
            <div id="content-zoom" class="hidden tab-content animate__animated animate__fadeIn">
                <div class="video-preview mb-5 shadow-sm border border-gray-50 relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-indigo-50/50"></div>
                    <div class="absolute inset-0 flex flex-col items-center justify-center p-4 text-center z-10">
                        <div class="w-12 h-12 bg-white text-blue-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/10 mb-3 transform rotate-3">
                             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </div>
                        <span class="text-[10px] font-extrabold text-blue-900 uppercase tracking-widest">Ruang Zoom</span>
                        <p class="text-[9px] text-blue-600/70 mt-1">Interaksi langsung dengan instruktur</p>
                    </div>
                </div>
                <a id="link-zm" href="#" onclick="window.trackClick('ZOOM')" target="_blank" class="btn-action w-full flex items-center justify-center gap-2 bg-blue-600 text-white py-4 rounded-2xl font-bold text-[11px] shadow-lg shadow-blue-100 tracking-wide uppercase">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M21 16.5V7.5L16 12L21 16.5ZM4 7C2.89543 7 2 7.89543 2 9V15C2 16.1046 2.89543 17 4 17H12C13.1046 17 14 16.1046 14 15V9C14 7.89543 13.1046 7 12 7H4Z"></path></svg>
                    Gabung Meeting Zoom
                </a>
            </div>

            <!-- Content: WhatsApp -->
            <div id="content-whatsapp" class="hidden tab-content animate__animated animate__fadeIn">
                <div class="video-preview mb-5 shadow-sm border border-gray-50 relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-green-50 to-emerald-50/50"></div>
                    <div class="absolute inset-0 flex flex-col items-center justify-center p-4 text-center z-10">
                        <div class="w-12 h-12 bg-white text-green-600 rounded-2xl flex items-center justify-center shadow-lg shadow-green-500/10 mb-3 transform rotate-3">
                             <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.506-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                        </div>
                        <span class="text-[10px] font-extrabold text-green-900 uppercase tracking-widest">Grup WhatsApp</span>
                        <p class="text-[9px] text-green-600/70 mt-1 max-w-[200px]">Bergabung ke Grup WhatsApp untuk mendapatkan Informasi lebih lengkap. Gabung Sekarang!</p>
                    </div>
                </div>
                <a id="link-wa" href="https://chat.whatsapp.com/HcdPwxYpL61K6HA3R6Cuqo" onclick="window.trackClick('WHATSAPP')" target="_blank" class="btn-action w-full flex items-center justify-center gap-2 bg-green-600 text-white py-4 rounded-2xl font-bold text-[11px] shadow-lg shadow-green-100 tracking-wide uppercase">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.506-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                    Bergabung
                </a>
            </div>

        </div>

        <!-- Attendance Status -->
        <div class="mt-4 flex justify-center">
            <div id="attendance-status-pill" class="bg-white/50 backdrop-blur-sm border border-gray-100 rounded-full px-4 py-1.5 flex items-center gap-2 opacity-0 transition-opacity duration-500">
                <div id="status-icon" class="w-2 h-2 rounded-full bg-gray-300"></div>
                <span id="attendance-text" class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Menunggu Check-in</span>
            </div>
        </div>

        <button onclick="window.logout()" class="mt-8 w-full text-center text-[10px] font-bold text-gray-300 hover:text-red-400 uppercase tracking-widest transition-colors">
            Keluar Sesi
        </button>

        <footer class="mt-8 text-center">
            <p class="text-[8px] text-gray-300 font-bold uppercase tracking-[0.3em]">GreciaEdu &copy; 2025</p>
        </footer>
    </div>

    <!-- State: Logged Out -->
    <div id="logged-out-view" class="hidden flex flex-col items-center justify-center animate__animated animate__fadeIn">
        <div class="w-16 h-16 bg-white rounded-2xl shadow-lg border border-slate-50 p-2 mb-6">
            <img src="https://greciaco.id/wp-content/uploads/2025/09/cropped-cropped-logo_grecia-1-e1758353731842.png" alt="Logo" class="w-full h-full object-contain grayscale opacity-50">
        </div>
        <div class="text-center space-y-2">
            <h2 class="text-lg font-bold text-slate-800">Sesi Berakhir</h2>
            <p class="text-xs text-slate-400 max-w-[200px] mx-auto leading-relaxed">Anda telah keluar dari sesi. Silakan klik kembali untuk melanjutkan Login Atau Registrasi.</p>
        </div>
        <a href="registrasilive.html" class="mt-8 px-6 py-3 bg-slate-900 text-white rounded-xl text-xs font-bold uppercase tracking-wider hover:bg-slate-800 transition-colors">
            Kembali
        </a>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 bg-slate-800 text-white px-5 py-2.5 rounded-xl text-[10px] font-bold uppercase tracking-widest shadow-2xl z-50 flex items-center gap-2">
        <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        <span id="toast-msg">Notifikasi</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, serverTimestamp, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyADKDlwOX4DNu05MFe9H1CY3r8NHoc9sQU",
            authDomain: "registrasi-user-grecia.firebaseapp.com",
            projectId: "registrasi-user-grecia",
            storageBucket: "registrasi-user-grecia.appspot.com",
            messagingSenderId: "656329307818",
            appId: "1:656329307818:web:78371ecba7b641d092c2d3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.appId;

        let activeTab = 'youtube';
        let currentSessionId = null;
        let currentUser = null;

        // --- UI Functions ---
        
        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            if (!t) return;
            
            msgEl.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        window.switchTab = (type) => {
            activeTab = type;
            renderTabs();
        };

        window.logout = () => {
            signOut(auth).then(() => {
                window.location.href = "registrasilive.html";
            });
        };

        function renderTabs() {
            const ytContent = document.getElementById('content-youtube');
            const zmContent = document.getElementById('content-zoom');
            const waContent = document.getElementById('content-whatsapp');
            
            const ytTab = document.getElementById('tab-yt');
            const zmTab = document.getElementById('tab-zm');
            const waTab = document.getElementById('tab-wa');
            
            const noSession = document.getElementById('no-session-state');
            const loader = document.getElementById('session-loader');

            // Hide loader & no session first
            loader.classList.add('hidden');
            
            // If no session active, hide contents and show no-session state
            if (!currentSessionId) {
                noSession.classList.remove('hidden');
                ytContent.classList.add('hidden');
                zmContent.classList.add('hidden');
                waContent.classList.add('hidden');
                return;
            }

            noSession.classList.add('hidden');

            if(activeTab === 'youtube') {
                ytContent.classList.remove('hidden');
                zmContent.classList.add('hidden');
                waContent.classList.add('hidden');
                ytTab.classList.add('active');
                zmTab.classList.remove('active');
                waTab.classList.remove('active');
            } else if (activeTab === 'zoom') {
                ytContent.classList.add('hidden');
                zmContent.classList.remove('hidden');
                waContent.classList.add('hidden');
                ytTab.classList.remove('active');
                zmTab.classList.add('active');
                waTab.classList.remove('active');
            } else if (activeTab === 'whatsapp') {
                ytContent.classList.add('hidden');
                zmContent.classList.add('hidden');
                waContent.classList.remove('hidden');
                ytTab.classList.remove('active');
                zmTab.classList.remove('active');
                waTab.classList.add('active');
            }
        }

        function getYoutubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url?.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function updateThumbnail(url) {
            const videoId = getYoutubeId(url);
            const ytThumb = document.getElementById('yt-thumb');
            const skeleton = document.getElementById('yt-skeleton');

            if (videoId) {
                const thumbUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
                const img = new Image();
                img.onload = () => {
                    if(ytThumb) {
                        ytThumb.src = thumbUrl;
                        ytThumb.classList.remove('hidden');
                    }
                    if (skeleton) skeleton.classList.add('hidden');
                };
                img.src = thumbUrl;
            } else {
                if(ytThumb) ytThumb.classList.add('hidden');
                if(skeleton) skeleton.classList.remove('hidden');
            }
        }

        function updateAttendanceUI(attended) {
            const pill = document.getElementById('attendance-status-pill');
            const text = document.getElementById('attendance-text');
            const icon = document.getElementById('status-icon');

            pill.style.opacity = '1';
            
            if (attended) {
                text.innerText = "Hadir (Tercatat)";
                text.classList.remove('text-gray-500');
                text.classList.add('text-emerald-600');
                icon.className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]";
                pill.className = "bg-emerald-50/80 backdrop-blur-sm border border-emerald-100 rounded-full px-4 py-1.5 flex items-center gap-2 transition-all duration-500";
            } else {
                text.innerText = "Menunggu Check-in";
                text.classList.add('text-gray-500');
                text.classList.remove('text-emerald-600');
                icon.className = "w-2 h-2 rounded-full bg-gray-300 animate-pulse";
                pill.className = "bg-white/50 backdrop-blur-sm border border-gray-100 rounded-full px-4 py-1.5 flex items-center gap-2 transition-all duration-500";
            }
        }

        function updateUserProfile(user, dbFullName = null) {
            // Gunakan nama dari DB jika ada, jika tidak gunakan display name auth, fallback ke 'User'
            const displayName = dbFullName || user.displayName || 'User';
            
            document.getElementById('user-name').innerText = displayName;
            
            const statusIndicator = document.getElementById('status-indicator');
            const avatar = document.getElementById('user-avatar');
            const initial = document.getElementById('user-initial');

            statusIndicator.innerText = "● Online";
            statusIndicator.classList.replace('text-gray-400', 'text-emerald-500');

            if (user.photoURL) {
                avatar.src = user.photoURL;
                avatar.classList.remove('hidden');
                initial.classList.add('hidden');
            } else {
                avatar.classList.add('hidden');
                initial.classList.remove('hidden');
                initial.innerText = displayName.charAt(0).toUpperCase();
            }
        }

        // --- Firebase Logic ---

        window.trackClick = async (channel) => {
            if (!currentUser || !currentSessionId) return;

            const docId = `${currentUser.uid}_${currentSessionId}`;
            const attendRef = doc(db, 'artifacts', appId, 'public', 'data', 'attendance', docId);
            
            try {
                const snap = await getDoc(attendRef);
                if (!snap.exists()) {
                    await setDoc(attendRef, {
                        uid: currentUser.uid,
                        userName: currentUser.displayName || 'Peserta',
                        userEmail: currentUser.email,
                        sessionId: currentSessionId,
                        channel: channel,
                        clickedAt: serverTimestamp()
                    });
                    showToast("Kehadiran Tercatat!");
                    updateAttendanceUI(true);
                }
            } catch (e) {
                console.error("Error recording attendance:", e);
                showToast("Gagal mencatat kehadiran", "error");
            }
        };

        async function checkAndAutoAttend(sessionId) {
            if (!currentUser || !sessionId) return;
            const docId = `${currentUser.uid}_${sessionId}`;
            const attendRef = doc(db, 'artifacts', appId, 'public', 'data', 'attendance', docId);

            try {
                const snap = await getDoc(attendRef);
                if (snap.exists()) {
                    updateAttendanceUI(true);
                } else {
                    updateAttendanceUI(false);
                }
            } catch (err) {
                console.error("Attendance check failed", err);
            }
        }

        // --- Main Auth Listener ---
        onAuthStateChanged(auth, async (user) => {
            const loadingOverlay = document.getElementById('loading-overlay');
            const mainContainer = document.getElementById('main-container');
            const loggedOutView = document.getElementById('logged-out-view');

            if (user) {
                currentUser = user;
                
                // Render awal dengan data Auth
                updateUserProfile(user);

                // Ambil FullName dari Collection 'registrations'
                try {
                    const q = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'registrations'), 
                        where('email', '==', user.email)
                    );
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const userData = querySnapshot.docs[0].data();
                        if (userData.fullName) {
                            updateUserProfile(user, userData.fullName);
                        }
                    }
                } catch (e) {
                    console.error("Gagal mengambil profil user:", e);
                }

                mainContainer.classList.remove('hidden');
                loggedOutView.classList.add('hidden');
                loadingOverlay.classList.add('opacity-0');
                setTimeout(() => loadingOverlay.style.display = 'none', 500);

                const settingsDoc = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'settings');
                
                onSnapshot(settingsDoc, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.data();
                        const newSessionId = data.sessionId;

                        if (newSessionId !== currentSessionId) {
                            currentSessionId = newSessionId;
                            
                            document.getElementById('link-yt').href = data.youtubeUrl || '#';
                            document.getElementById('link-zm').href = data.zoomUrl || '#';
                            updateThumbnail(data.youtubeUrl);
                            
                            updateAttendanceUI(false); 
                            checkAndAutoAttend(currentSessionId);
                        }
                        renderTabs();
                    } else {
                        currentSessionId = null;
                        
                        renderTabs();
                    }
                }, (error) => {
                    console.error("Firestore Error:", error);
                    showToast("Gagal sinkronisasi data", "error");
                });

            } else {
                currentUser = null;
                loadingOverlay.style.display = 'none';
                mainContainer.classList.add('hidden');
                loggedOutView.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
