<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Peserta | GreciaEdu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #ffffff;
            background-image: radial-gradient(at 0% 0%, hsla(210,100%,99%,1) 0, transparent 50%), 
                              radial-gradient(at 100% 100%, hsla(210,100%,99%,1) 0, transparent 50%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .minimal-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid #f3f4f6;
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.05);
        }

        .tab-btn {
            position: relative;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: #2563eb;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 25%;
            width: 50%;
            height: 3px;
            background: #2563eb;
            border-radius: 10px;
        }

        .video-preview {
            border-radius: 20px;
            overflow: hidden;
            background: #f1f5f9;
            aspect-ratio: 16 / 9;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #f8fafc 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .btn-action {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-action:active {
            transform: scale(0.96);
        }

        #toast {
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform: translateY(100px) translateX(-50%);
            opacity: 0;
            left: 50%;
        }
        #toast.show {
            transform: translateY(0) translateX(-50%);
            opacity: 1;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest animate-pulse">Memuat Data...</p>
    </div>

    <!-- Main Dashboard Container -->
    <div id="main-container" class="w-full max-w-sm hidden animate__animated animate__fadeIn">
        
        <!-- Header & Profile -->
        <div class="flex items-center justify-between mb-8 px-2">
            <div class="flex items-center gap-2.5">
                <div class="w-10 h-10 bg-white rounded-xl shadow-sm border border-slate-50 p-1.5">
                    <img src="https://greciaco.id/wp-content/uploads/2025/09/cropped-cropped-logo_grecia-1-e1758353731842.png" alt="Logo" class="w-full h-full object-contain">
                </div>
                <div>
                    <h1 class="font-bold text-slate-800 text-sm leading-tight">Grecia<span class="text-blue-600">Edu</span></h1>
                    <p class="text-[10px] text-slate-400 font-medium">Dashboard Peserta</p>
                </div>
            </div>
            
            <div id="user-profile" class="flex items-center gap-2 bg-white/60 p-1.5 pr-3 rounded-full border border-slate-100 shadow-sm backdrop-blur-sm">
                <div id="user-initial" class="w-7 h-7 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-[10px] font-bold text-white shadow-sm border border-white">
                    ?
                </div>
                <div class="flex flex-col">
                    <span id="user-name" class="text-[10px] font-bold text-slate-700 leading-none truncate max-w-[80px]">User</span>
                    <span class="text-[8px] text-emerald-500 font-bold leading-none mt-0.5">As Users</span>
                </div>
            </div>
        </div>

        <!-- Main Card -->
        <div class="minimal-card rounded-[2.5rem] p-6 relative overflow-hidden">

            <!-- Tabs Navigation -->
            <div class="flex border-b border-slate-100 mb-6 mr-16">
                <button onclick="window.switchTab('youtube')" id="tab-yt" class="tab-btn active flex-1 pb-3 text-xs font-bold uppercase tracking-widest text-slate-400 hover:text-blue-500">YouTube</button>
                <button onclick="window.switchTab('zoom')" id="tab-zm" class="tab-btn flex-1 pb-3 text-xs font-bold uppercase tracking-widest text-slate-400 hover:text-blue-500">Zoom</button>
            </div>

            <!-- Loader State -->
            <div id="session-loader" class="py-12 text-center hidden">
                <div class="w-8 h-8 border-2 border-slate-100 border-t-blue-500 rounded-full animate-spin mx-auto mb-3"></div>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Sinkronisasi Sesi...</p>
            </div>

            <!-- No Session State -->
            <div id="no-session-state" class="py-10 text-center hidden">
                <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-300">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h3 class="text-slate-800 font-bold text-sm">Belum Ada Sesi</h3>
                <p class="text-[10px] text-slate-400 mt-1 max-w-[200px] mx-auto leading-relaxed">Admin belum memulai sesi live. Silakan tunggu sebentar.</p>
            </div>

            <!-- Content: YouTube -->
            <div id="content-youtube" class="tab-content animate__animated animate__fadeIn">
                <div class="video-preview mb-5 shadow-sm border border-white relative group">
                    <div id="yt-skeleton" class="skeleton absolute inset-0"></div>
                    <img id="yt-thumb" src="" class="hidden w-full h-full object-cover transition-transform duration-700 group-hover:scale-105">
                    <div class="absolute inset-0 bg-black/5 flex items-center justify-center group-hover:bg-black/10 transition-colors">
                         <div class="w-12 h-12 bg-white/90 backdrop-blur-md rounded-full flex items-center justify-center shadow-lg transform group-hover:scale-110 transition-transform duration-300">
                            <svg class="w-5 h-5 text-red-600 ml-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                        </div>
                    </div>
                </div>
                <a id="link-yt" href="#" onclick="window.trackClick('YOUTUBE')" target="_blank" class="btn-action w-full flex items-center justify-center gap-2 bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white py-4 rounded-2xl font-bold text-[11px] shadow-lg shadow-red-500/20 tracking-wide uppercase">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"></path></svg>
                    Buka YouTube Live
                </a>
            </div>

            <!-- Content: Zoom -->
            <div id="content-zoom" class="hidden tab-content animate__animated animate__fadeIn">
                <div class="video-preview mb-5 shadow-sm border border-white relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-blue-50 to-indigo-50/50"></div>
                    <div class="absolute inset-0 flex flex-col items-center justify-center p-4 text-center z-10">
                        <div class="w-14 h-14 bg-white text-blue-600 rounded-2xl flex items-center justify-center shadow-lg shadow-blue-500/10 mb-3 transform rotate-3">
                             <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </div>
                        <span class="text-xs font-extrabold text-blue-900 uppercase tracking-widest">Ruang Interaktif Zoom</span>
                        <p class="text-[9px] text-blue-600/70 mt-1">Tanya jawab langsung dengan instruktur</p>
                    </div>
                    <!-- Decorative Circles -->
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-blue-500/5 rounded-full blur-2xl"></div>
                    <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-indigo-500/5 rounded-full blur-2xl"></div>
                </div>
                <a id="link-zm" href="#" onclick="window.trackClick('ZOOM')" target="_blank" class="btn-action w-full flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white py-4 rounded-2xl font-bold text-[11px] shadow-lg shadow-blue-500/20 tracking-wide uppercase">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M21 16.5V7.5L16 12L21 16.5ZM4 7C2.89543 7 2 7.89543 2 9V15C2 16.1046 2.89543 17 4 17H12C13.1046 17 14 16.1046 14 15V9C14 7.89543 13.1046 7 12 7H4Z"></path></svg>
                    Gabung Meeting Zoom
                </a>
            </div>

        </div>

        <!-- Attendance Status -->
        <div class="mt-4 flex justify-center">
            <div id="attendance-status-pill" class="bg-white/50 backdrop-blur-sm border border-slate-100 rounded-full px-4 py-1.5 flex items-center gap-2 opacity-0 transition-opacity duration-500">
                <div id="status-icon" class="w-2 h-2 rounded-full bg-slate-300"></div>
                <span id="attendance-text" class="text-[10px] font-bold text-slate-500 uppercase tracking-wide">Menunggu Check-in</span>
            </div>
        </div>

        <button onclick="window.logout()" class="mt-8 w-full text-center text-[10px] font-bold text-slate-300 hover:text-red-400 uppercase tracking-widest transition-colors flex items-center justify-center gap-1 group">
            <svg class="w-3 h-3 group-hover:-translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
            Keluar Sesi
        </button>

        <footer class="mt-8 text-center">
            <p class="text-[8px] text-slate-300 font-bold uppercase tracking-[0.3em]">GreciaEdu &copy; 2025</p>
        </footer>
    </div>

    <!-- State: Logged Out -->
    <div id="logged-out-view" class="hidden flex flex-col items-center justify-center animate__animated animate__fadeIn">
        <div class="w-16 h-16 bg-white rounded-2xl shadow-lg border border-slate-50 p-2 mb-6">
            <img src="https://greciaco.id/wp-content/uploads/2025/09/cropped-cropped-logo_grecia-1-e1758353731842.png" alt="Logo" class="w-full h-full object-contain grayscale opacity-50">
        </div>
        <div class="text-center space-y-2">
            <h2 class="text-lg font-bold text-slate-800">Sesi Berakhir</h2>
            <p class="text-xs text-slate-400 max-w-[200px] mx-auto leading-relaxed">Anda telah keluar dari sesi. Silakan login kembali untuk melanjutkan.</p>
        </div>
        <a href="register.html" class="mt-8 px-6 py-3 bg-slate-900 text-white rounded-xl text-xs font-bold uppercase tracking-wider hover:bg-slate-800 transition-colors">
            Login Kembali
        </a>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-10 bg-slate-800 text-white px-5 py-2.5 rounded-xl text-[10px] font-bold uppercase tracking-widest shadow-2xl z-50 flex items-center gap-2">
        <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
        <span id="toast-msg">Notifikasi</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyADKDlwOX4DNu05MFe9H1CY3r8NHoc9sQU",
            authDomain: "registrasi-user-grecia.firebaseapp.com",
            projectId: "registrasi-user-grecia",
            storageBucket: "registrasi-user-grecia.appspot.com",
            messagingSenderId: "656329307818",
            appId: "1:656329307818:web:78371ecba7b641d092c2d3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.appId;

        let activeTab = 'youtube';
        let currentSessionId = null;
        let currentUser = null;

        // --- UI Functions ---
        
        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            if (!t) return;
            
            msgEl.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        window.switchTab = (type) => {
            activeTab = type;
            renderTabs();
        };

        window.logout = () => {
            signOut(auth).then(() => {
                window.location.href = "register.html";
            });
        };

        function renderTabs() {
            const ytContent = document.getElementById('content-youtube');
            const zmContent = document.getElementById('content-zoom');
            const ytTab = document.getElementById('tab-yt');
            const zmTab = document.getElementById('tab-zm');
            const noSession = document.getElementById('no-session-state');
            const loader = document.getElementById('session-loader');

            // Hide loader & no session first
            loader.classList.add('hidden');
            
            // If no session active, hide contents and show no-session state
            if (!currentSessionId) {
                noSession.classList.remove('hidden');
                ytContent.classList.add('hidden');
                zmContent.classList.add('hidden');
                return;
            }

            noSession.classList.add('hidden');

            if(activeTab === 'youtube') {
                ytContent.classList.remove('hidden');
                zmContent.classList.add('hidden');
                ytTab.classList.add('active');
                zmTab.classList.remove('active');
            } else {
                ytContent.classList.add('hidden');
                zmContent.classList.remove('hidden');
                ytTab.classList.remove('active');
                zmTab.classList.add('active');
            }
        }

        function getYoutubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url?.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function updateThumbnail(url) {
            const videoId = getYoutubeId(url);
            const ytThumb = document.getElementById('yt-thumb');
            const skeleton = document.getElementById('yt-skeleton');

            if (videoId) {
                const thumbUrl = `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`;
                const img = new Image();
                img.onload = () => {
                    if(ytThumb) {
                        ytThumb.src = thumbUrl;
                        ytThumb.classList.remove('hidden');
                    }
                    if (skeleton) skeleton.classList.add('hidden');
                };
                img.src = thumbUrl;
            } else {
                if(ytThumb) ytThumb.classList.add('hidden');
                if(skeleton) skeleton.classList.remove('hidden');
            }
        }

        function updateAttendanceUI(attended) {
            const pill = document.getElementById('attendance-status-pill');
            const text = document.getElementById('attendance-text');
            const icon = document.getElementById('status-icon');

            pill.style.opacity = '1';
            
            if (attended) {
                text.innerText = "Hadir (Tercatat)";
                text.classList.remove('text-slate-500');
                text.classList.add('text-emerald-600');
                icon.className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]";
                pill.className = "bg-emerald-50/80 backdrop-blur-sm border border-emerald-100 rounded-full px-4 py-1.5 flex items-center gap-2 transition-all duration-500";
            } else {
                text.innerText = "Menunggu Check-in";
                text.classList.add('text-slate-500');
                text.classList.remove('text-emerald-600');
                icon.className = "w-2 h-2 rounded-full bg-slate-300 animate-pulse";
                pill.className = "bg-white/50 backdrop-blur-sm border border-slate-100 rounded-full px-4 py-1.5 flex items-center gap-2 transition-all duration-500";
            }
        }

        // --- Firebase Logic ---

        // Catat Absensi (Manual Klik)
        window.trackClick = async (channel) => {
            if (!currentUser || !currentSessionId) return;

            // ID Unik: UID + SESSIONID (Konsisten dengan Dashboard Admin)
            const docId = `${currentUser.uid}_${currentSessionId}`;
            const attendRef = doc(db, 'artifacts', appId, 'public', 'data', 'attendance', docId);
            
            try {
                // Cek dulu biar gak overwrite timestamp lama
                const snap = await getDoc(attendRef);
                if (!snap.exists()) {
                    await setDoc(attendRef, {
                        uid: currentUser.uid,
                        userName: currentUser.displayName || 'Peserta',
                        userEmail: currentUser.email,
                        sessionId: currentSessionId,
                        channel: channel,
                        clickedAt: serverTimestamp()
                    });
                    showToast("Kehadiran Tercatat!");
                    updateAttendanceUI(true);
                } else {
                    // Sudah absen sebelumnya
                    // Optional: update channel kalau pindah platform?
                    // await setDoc(attendRef, { channel: channel }, { merge: true });
                }
            } catch (e) {
                console.error("Error recording attendance:", e);
                showToast("Gagal mencatat kehadiran", "error");
            }
        };

        // Auto Attend Logic (Saat sesi dimuat)
        async function checkAndAutoAttend(sessionId) {
            if (!currentUser || !sessionId) return;

            const docId = `${currentUser.uid}_${sessionId}`;
            const attendRef = doc(db, 'artifacts', appId, 'public', 'data', 'attendance', docId);

            try {
                const snap = await getDoc(attendRef);
                if (snap.exists()) {
                    updateAttendanceUI(true);
                } else {
                    updateAttendanceUI(false);
                    // Jika ingin auto-attend saat dashboard dibuka, uncomment baris bawah:
                    // window.trackClick('AUTO_DASHBOARD');
                }
            } catch (err) {
                console.error("Attendance check failed", err);
            }
        }

        // --- Main Auth Listener ---
        onAuthStateChanged(auth, (user) => {
            const loadingOverlay = document.getElementById('loading-overlay');
            const mainContainer = document.getElementById('main-container');
            const loggedOutView = document.getElementById('logged-out-view');

            if (user) {
                currentUser = user;
                
                // Update User Profile UI
                document.getElementById('user-initial').innerText = (user.displayName || 'U').charAt(0).toUpperCase();
                document.getElementById('user-name').innerText = (user.displayName || 'User').split(' ')[0];

                // Show Dashboard
                mainContainer.classList.remove('hidden');
                loggedOutView.classList.add('hidden');
                
                // Hide main loading overlay nicely
                loadingOverlay.classList.add('opacity-0');
                setTimeout(() => loadingOverlay.style.display = 'none', 500);

                // Listen to Global Settings (Session)
                const settingsDoc = doc(db, 'artifacts', appId, 'public', 'data', 'global', 'settings');
                
                onSnapshot(settingsDoc, (snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.data();
                        const newSessionId = data.sessionId;

                        // Jika sesi berubah/baru dimuat
                        if (newSessionId !== currentSessionId) {
                            currentSessionId = newSessionId;
                            
                            // Update Links & Thumbnails
                            document.getElementById('link-yt').href = data.youtubeUrl || '#';
                            document.getElementById('link-zm').href = data.zoomUrl || '#';
                            updateThumbnail(data.youtubeUrl);
                            updateSessionBadge(currentSessionId);
                            
                            // Reset & Check Absensi untuk sesi baru ini
                            updateAttendanceUI(false); 
                            checkAndAutoAttend(currentSessionId);
                        }
                        
                        renderTabs();
                    } else {
                        currentSessionId = null;
                        updateSessionBadge(null);
                        renderTabs();
                    }
                }, (error) => {
                    console.error("Firestore Error:", error);
                    showToast("Gagal sinkronisasi data", "error");
                });

            } else {
                // Logged Out State
                currentUser = null;
                loadingOverlay.style.display = 'none';
                mainContainer.classList.add('hidden');
                loggedOutView.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
